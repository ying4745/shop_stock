{% extends 'base.html' %}
{% load static %}
{% block title %}商品信息{% endblock %}

{% block content %}

    <section class="content">
        <div class="row">
            <p class="update_div text-blue">获取商品信息</p>
            <div class="update_div">
                <button class="btn btn-primary good_btn" data-value="all" data-country="MY">
                    <i class="fa fa-battery-empty"></i> (马来西亚) 全部商品
                </button>
                <button class="btn btn-primary good_btn" data-country="MY">
                    <i class="fa fa-battery-full"></i> (马来西亚) 第一页商品
                </button>
                <button class="btn btn-vk good_btn" data-value="all" data-country="PH">
                    <i class="fa fa-hourglass-o"></i> (菲律宾) 全部商品
                </button>
                <button class="btn btn-vk good_btn" data-country="PH">
                    <i class="fa fa-hourglass"></i> (菲律宾) 第一页商品
                </button>
            </div>
        </div>

        <div class="row">
            <div class="col-xs-12">
                <div class="box">
                    <div class="box-header">
                        <h3 class="box-title">商品信息
                        </h3>
                        <div class="good_update">
                            <label><input type="text" class="form-control input-sm" id="input_url" style="width: 500px;"
                                          placeholder="淘宝、1688链接，最多三个，用';;'分割开"></label>
                            <label><input type="text" class="form-control input-sm" id="input_weight"
                                          style="width: 90px;" placeholder="最大实重(g)"></label>
                            <label><input type="text" class="form-control input-sm" id="input_price"
                                          style="width: 80px;" placeholder="进货价"></label>
                            <label>
                                <button onclick="update_price()" class="btn-sm btn-primary">更新选中</button>
                            </label>
                        </div>
                        {% csrf_token %}
                    </div>
                    <div class="box-body">
                        <table id="order_table" class="table table-bordered table-striped">
                            <thead>
                            <tr>
                                <th>序号</th>
                                <th>商品SPU</th>
                                <th>最大实重</th>
                                <th>链接</th>
                                <th>子商品SKU</th>
                                <th>商品规格</th>
                                <th>商品图片</th>
                                <th>进货价</th>
                                <th>库存</th>
                                <th>销量</th>
                                <th>(MY)售价</th>
                                <th>(PH)售价</th>
                                <th>(TH)售价</th>
                                <th>货架号</th>
                            </tr>
                            </thead>


                            <tfoot>
                            <tr>
                                <th>序号</th>
                                <th>商品SPU</th>
                                <th>最大实重</th>
                                <th>链接</th>
                                <th>子商品SKU</th>
                                <th>商品规格</th>
                                <th>商品图片</th>
                                <th>进货价</th>
                                <th>库存</th>
                                <th>销量</th>
                                <th>(MY)售价</th>
                                <th>(PH)售价</th>
                                <th>(TH)售价</th>
                                <th>货架号</th>
                            </tr>
                            </tfoot>
                        </table>
                    </div> <!-- /.box-body -->
                </div> <!-- /.box -->
            </div> <!-- /.col -->
        </div> <!-- /.row -->
    </section>

{% endblock %}

{% block script %}

    <script src="{% static 'adminlet-2.4.10/bower_components/datatables.net/js/jquery.dataTables.min.js' %}"></script>
    <script src="{% static 'adminlet-2.4.10/bower_components/datatables.net-bs/js/dataTables.bootstrap.min.js' %}"></script>
    <script src="{% static 'JS/jquery.cookie.js' %}"></script>
    <script src="{% static 'JS/base.js' %}"></script>

    <script>
        var columnDefs = [
            {
                "targets": [0, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13],
                "searchable": false
            },
            {
                "targets": [0, 2, 3, 5, 6, 13],
                "orderable": false
            },
        ];

        $(function () {
            var table = $('#order_table').DataTable({
                "searching": true,    <!-- 允许内容搜索 -->
                "ordering": true,     <!-- 允许排序 -->
                "order": [[1, 'desc'], [4, 'asc']], <!-- 初始排序列表 -->
                "info": true,         <!-- 显示信息 -->
                "pageLength": 50,    <!-- 每页显示 -->
                "autoWidth": false,  <!-- 自动宽度 -->
                "scrollX": false,  <!-- 水平滚动 -->
                "language": language,  <!-- 语言 -->
                "columnDefs": columnDefs,  <!-- 指定列 定义属性 -->
                "deferRender": true, <!-- 延迟渲染 -->
                "dom": '<"table_top"fi>prtp',

                // 开启服务器模式
                "serverSide": true,
                // 开启处理功能
                "processing": true,
                // 发送post请求
                "ajax": {
                    "type": 'POST',
                    "url": "{% url 'goods_list' %}",
                    "data": function (d) {
                        return $.extend(d, {
                            "csrfmiddlewaretoken": $.cookie('csrftoken')
                        });
                    }
                },
                // 每一列
                "columns": [
                    {   "data": null,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1
                        }
                    },
                    {
                        "data": "goods",
                        "render": function (data, type, row, meta) {
                            $(table.cell(meta.row, meta.col).node()).addClass('select_td');
                            return data
                        }
                    },
                    {"data": "max_weight"},
                    {
                        "data": "g_url",
                        // 列渲染 以';;'分割url 分别生成超链接
                        "render": function (data, type, row, meta) {
                            var data_html = '';
                            data = data.split(';;');
                            if (data == false) {
                                return ''
                            } else {
                                $.each(data, function (i, v) {
                                    if (v) {
                                        data_html += '<a target="_blank" href="' + v + '">链接' + (i + 1) + '</a></br>'
                                    }
                                });
                                return data_html;
                            }
                        },
                    },
                    {"data": "sku_id"},
                    {"data": "desc"},
                    {
                        "data": "image",
                        "render": function (data, type, row, meta) {
                            // meta row和col 索引信息
                            $(table.cell(meta.row, meta.col).node()).addClass('good_img');
                            return '<img width="60" height="60" src="{{ MEDIA_URL }}' + data + '">'
                        }
                    },
                    {
                        "data": "buy_price",
                        "render": function (data, type, row, meta) {
                            $(table.cell(meta.row, meta.col).node())
                                .addClass('edit_td').attr('data-type', 'buy_price');
                            return data
                        }
                    },
                    {
                        "data": "stock",
                        "render": function (data, type, row, meta) {
                            $(table.cell(meta.row, meta.col).node())
                                .addClass('edit_td').attr('data-type', 'stock');
                            return data
                        }
                    },
                    {"data": "sales"},
                    {"data": "my_sale_price"},
                    {"data": "ph_sale_price"},
                    {"data": "th_sale_price"},
                    {"data": "shelf"},
                ]

            });

            // 鼠标悬停 高亮行
            $('#order_table tbody').on('mouseover', 'tr', function () {
                $(table.row(this).node()).addClass('highlight')
            }).on('mouseleave', 'tr', function () {
                $(table.row(this).node()).removeClass('highlight')
            });

            // 鼠标悬浮显示大图 生成的html 需要on绑定父元素
            $("#order_table").on('mouseover mouseout', '.good_img', function (e) {
                if (e.type === 'mouseover') {
                    $(this).append('<p id="bigimage"><img src="' +
                        $(this).find('img').attr('src') + '"></p>');
                } else {
                    $("#bigimage").remove();
                }
            });

            // 双击单元格 变输入框 进价、库存修改
            $('#order_table').on('dblclick', '.edit_td', function () {
                var input_obj = $('<input class="form-control" style="width: 70px;" type="text">');
                var old_obj = $(this);
                var old_data = $(this).text();
                var data_type = $(this).attr('data-type');
                var sku_id = table.row(table.cell(old_obj).index().row).data().sku_id;
                var data = {'sku_id': sku_id};

                input_obj.val(old_data);
                old_obj.html(input_obj);
                // 获取焦点并选中 失去焦点 提交数据修改
                input_obj.focus().select().blur(function () {
                    var new_data = $(this).val();
                    // 没有输入、和原来的值相等、数据为price 转成小数后并与原来的值相等 则不处理
                    if (!new_data ||
                        new_data === old_data ||
                        (data_type === 'buy_price' && getFloat2(new_data) === old_data)) {
                        old_obj.text(old_data);
                        return
                    }
                    // 验证值 是否为数字
                    if (/^[0-9]+\.?[0-9]*$/.test(new_data)) {
                        data[data_type] = new_data;
                        $.ajax({
                            url: '{% url 'modify_good' %}',
                            type: 'post',
                            headers: {"X-CSRFToken": $.cookie('csrftoken')},
                            data: {
                                'update_data': JSON.stringify(data),
                            },
                            success: function (e) {
                                if (!e.status) {
                                    showMessage(e.msg, 'bg-success');
                                    if (data_type === 'buy_price') {
                                        old_obj.text(getFloat2(new_data))
                                    } else {
                                        old_obj.text(new_data)
                                    }
                                } else {
                                    showMessage(e.msg);
                                    old_obj.text(old_data)
                                }
                            }
                        })
                    } else {
                        showMessage('请输入正确的数字')
                    }
                });
            });


            // 选中商品
            $('#order_table').on('click', '.select_td', function () {
                if ($(this).hasClass('selected')) {
                    $(this).removeClass('selected');
                    $('#input_url').val('');
                } else {
                    $('#order_table tbody td.selected').removeClass('selected');
                    $(this).addClass('selected');
                    //console.log(table.row(table.cell(this).index().row).data());
                    $('#input_url').val(table.row(table.cell(this).index().row).data().g_url);
                }
            });

            // 爬取商品信息按钮，根据数据类型，国家来爬取
            $('.good_btn').click(function () {
                var this_obj = $(this);
                var good_type = this_obj.attr('data-value');
                var country_type = this_obj.attr('data-country');
                var data = {
                    'data_type': good_type,
                    'country_type': country_type
                };
                this_obj.addClass('disabled');

                $.get("{% url 'get_product' %}", params = data, function (e) {
                    if (!e.status) {
                        showMessage(e.msg, 'bg-success');
                        window.setTimeout(function () {
                            location.reload()
                        }, 2100);
                    } else {
                        showMessage(e.msg)
                    }
                });
                // 禁用 延迟10s再点击
                window.setTimeout(function () {
                    this_obj.removeClass('disabled')
                }, 10000);
            });

        });

        // 更新商品的进价，实重， URL
        function update_price() {
            var table = $('#order_table').DataTable();

            // 获取输入框的值
            var new_price = $('#input_price').val();
            var new_weight = $('#input_weight').val();
            var new_url = $('#input_url').val();

            // 校验数字和重量的正则表达式
            var reg_num = /^[0-9]+\.?[0-9]*$/;
            var reg_weight = /^[0-9]+0$/;
            var reg_url = /^((ht|f)tps?):\/\/[\w\-]+(\.[\w\-]+)+([\w\-.,@?^=%&:\/~+#]*[\w\-@?^=%&\/~+#])?$/;

            // 价格和重量、URL必须输入一项
            if (new_price || new_weight || new_url) {
                var data = {};
                // 如果有价格输入，检验处理保存
                if (new_price) {
                    if (reg_num.test(new_price)) {
                        data.buy_price = new_price
                    } else {
                        showMessage('输入正确的价格');
                        return
                    }
                }
                // 如果有重量输入，检验处理
                if (new_weight) {
                    if (reg_weight.test(new_weight)) {
                        data.max_weight = new_weight
                    } else {
                        showMessage('重量为10g倍数');
                        return
                    }
                }
                if (new_url) {
                    var url_ok = true;
                    $.each(new_url.split(';;'), function (i, v) {
                        if (v && !reg_url.test(v)) {
                            url_ok = false;
                            // 跳出所有循环
                            return false
                        }
                    });
                    if (url_ok) {
                        data.g_url = new_url;
                    } else {
                        showMessage('URL格式错误');
                        return;
                    }
                }
                // 判断有无选中行
                if (!table.cell('.selected').index()) {
                    showMessage('先选中');
                } else {
                    data.spu_id = $('td.selected').text();
                    // 发起请求 更新数据库
                    $.ajax({
                        url: '{% url 'modify_good' %}',
                        type: 'post',
                        headers: {"X-CSRFToken": $.cookie('csrftoken')},
                        data: {
                            'update_data': JSON.stringify(data),
                        },
                        success: function (e) {
                            if (!e.status) {
                                showMessage(e.msg, 'bg-success');
                                // 表格刷新，保留分页
                                table.ajax.reload(null, false);
                                $('#input_url').val('');
                                $('#input_price').val('');
                            } else {
                                showMessage(e.msg)
                            }
                        }
                    })
                }
            }
        }

    </script>

{% endblock %}